<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />
    
    <link type="text/css" rel="stylesheet" href="css/graph.css">
    <link type="text/css" rel="stylesheet" href="css/detail.css">
    <link type="text/css" rel="stylesheet" href="css/legend.css">
    <link type="text/css" rel="stylesheet" href="css/lines.css">

    <script src="vendor/d3.min.js"></script>
    <script src="vendor/d3.layout.min.js"></script>
    <script src="rickshaw.min.js"></script>
    <script src="vendor/moment.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.15/jquery-ui.min.js"></script>
    <script src="http://d23cj0cdvyoxg0.cloudfront.net/xivelyjs-1.0.3.min.js"></script>  
    <script src=https://dl.dropboxusercontent.com/u/2986612/tween-min.js></script>
    <script src=https://dl.dropboxusercontent.com/u/2986612/steelseries-min.js></script>

    <title>Domotica Experiment by rogierg</title>
  </head>

<body>

    <header>
      <div class="container">
        <h1>Domotica Experiment</h1>
        <h2>A little Arduino powered experiment I'm working on</h2>

        <section id="downloads">
          <a href="https://github.com/rogierg/xively/zipball/master" class="btn">Download as .zip</a>
          <a href="https://github.com/rogierg/xively/tarball/master" class="btn">Download as .tar.gz</a>
          <a href="https://github.com/rogierg/xively" class="btn btn-github"><span class="icon"></span>View on GitHub</a>
        </section>
      </div>
    </header>

    <div class="container">
      <section id="main_content">
        <h3>
<a name="what-is-all-this-then" class="anchor" href="#what-is-all-this-then"><span class="octicon octicon-link"></span></a>What is all this then?</h3>

<p>I wanted an energy tracker for use at home. Instead of buying one I decided to build one using an Arduino an IR sensor and a bit of hacking. It turned out okay, I would say.</p>

<h3>
<a name="how-does-it-work" class="anchor" href="#how-does-it-work"><span class="octicon octicon-link"></span></a>How does it work?</h3>

<p>I have stuck an IR sensor to my KWH meter, this sensor bounces IR light off the wheel in the sensor and measures the amount of reflected light. Code on the Arduino interprets the signal and times the time between passages of the black stripe. It also sends the data to Xively through an ethernet interface.</p>
      </section>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="container">
      <section id="main_content" class="inner" style="height: 480px">
      <div id="chart_container" >
          <div id="chart"></div>
          <div id="legend_container">
            <div id="smoother" title="Smoothing"></div>
            <div id="legend"></div>
          </div>
          <div id="slider"></div>

<script>
 function init()
 {
  // Initialzing gauge
      tempGauge = new steelseries.Radial('gaugeCanvas', {
               gaugeType: steelseries.GaugeType.TYPE4,
    minValue:0,
                  maxValue:5000,
                  size: 200,
                  frameDesign: steelseries.FrameDesign.Steel,
    knobStyle: steelseries.KnobStyle.SILVER,
           pointerType: steelseries.PointerType.TYPE6,
           lcdDecimals: 1,
                  section: null,
                  area: null,
                  titleString: 'Power',
                  unitString: 'W',
                  thresholdVisible: false,
                  lcdVisible: true
                  });


    // Start the gauge update
  setInterval(function(){
            var site = "https://api.xively.com/v2/feeds/1116617964.json?&key=alheO4BHm8CpDDQIaoE4tKt28r4GTHPo76HqDMfcnPteo7WK&&datastreams=118";
  //alert('going for ' + site);
  $.ajax({
       type: 'GET',
       url: site,
       dataType: 'json',
   cache: false,
   data: {},
   processData: true,
       async: false, // you have to have this so the data will arrive before display
       success: function(data_archive) {
     //alert("the url returned success");
    //alert("got back " + data_archive.datastreams[0].current_value);
                        tempGauge.setValueAnimated(eval(data_archive.datastreams[0].current_value));
   },
   error: function(a){
    //alert("here I am in the error routine");
   }
  });
  //alert('after the get');
  }, 10000);
 }
</script>
          
      </div>

<script>
// Set your API key first  
xively.setKey( "alheO4BHm8CpDDQIaoE4tKt28r4GTHPo76HqDMfcnPteo7WK" );  

var startOfData = moment().subtract("day", 90).startOf('day');
var endOfData = moment().subtract("hour", 3).startOf('day');

console.log(startOfData);
console.log(endOfData);

var query = { 
  start: startOfData.toJSON(), 
  end: endOfData.toJSON(), 
  interval: 60 * 60 * 24, 
  limit: 1000,
};

xively.datastream.history( "1116617964", "118", query, loadData);  

function loadData(data) {  
  var unit = data.unit.label;
  var series = [];
  var filtedData = data.datapoints;
  for (var i=0; i < filtedData.length; i++ ) {
    var date = moment(filtedData[i].at);
    var value = parseInt(filtedData[i].value);
    series[i] = {x: date.unix(), y: value};
  }
  drawGraph(series, unit);
}

function drawGraph(data, unit) {
  var graph = new Rickshaw.Graph( {
    element: document.querySelector("#chart"),
    width: 640,
    height: 400,
    renderer: 'line',
    series: [
      {
        data: data,
        color: '#6060c0',
        name: unit
      }
    ]
  } );
  graph.render();

  var hoverDetail = new Rickshaw.Graph.HoverDetail( {
    graph: graph
  } );

  var legend = new Rickshaw.Graph.Legend( {
    graph: graph,
    element: document.getElementById('legend')
  } );

  var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
    graph: graph,
    legend: legend
  } );


  var axes = new Rickshaw.Graph.Axis.Time( {
    graph: graph
  });
  axes.render();
  
  var yAxis = new Rickshaw.Graph.Axis.Y({
      graph: graph
  });

  yAxis.render();
}
</script>
    
</body>
</html>
